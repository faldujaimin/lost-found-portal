{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Item History</h1>
        <p class="text-muted">Complete archive of all reported items (Admin/HOD only)</p>
    </div>

    <!-- Filter Options -->
    <div class="card mb-6">
        <div class="card-content">
            <div class="flex gap-2 flex-wrap">
                <a href="{{ url_for('item_history') }}"
                    class="btn btn-sm {% if not request.args.get('status') %}btn-primary{% else %}btn-outline{% endif %}">
                    All Items
                </a>
                <a href="{{ url_for('item_history', status='active') }}"
                    class="btn btn-sm {% if request.args.get('status') == 'active' %}btn-primary{% else %}btn-outline{% endif %}">
                    Active Only
                </a>
                <a href="{{ url_for('item_history', status='archived') }}"
                    class="btn btn-sm {% if request.args.get('status') == 'archived' %}btn-primary{% else %}btn-outline{% endif %}">
                    Archived Only
                </a>
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="card">
        <div class="card-content" style="padding: 0; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: hsl(var(--muted) / 0.5); border-bottom: 2px solid hsl(var(--border));">
                    <tr>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Item</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">
                            Description</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Status
                        </th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Date</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Location
                        </th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Reported
                            By</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Reported
                            At</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">State
                        </th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Deleted
                            Info</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr
                        style="border-bottom: 1px solid hsl(var(--border)); {% if not item.is_active %}background: hsl(var(--destructive) / 0.05);{% endif %}">
                        <td style="padding: 0.75rem;">
                            <div class="font-semibold text-sm">{{ item.item_name }}</div>
                            {% if item.verification_score %}
                            <div class="text-xs text-muted mt-1">
                                {% set confidence_pct = (item.verification_score * 100) | int %}
                                AI: <span
                                    class="{% if confidence_pct >= 70 %}text-success{% elif confidence_pct >= 40 %}text-warning{% else %}text-destructive{% endif %}">{{
                                    confidence_pct }}%</span>
                            </div>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem; max-width: 200px;">
                            <p class="text-sm text-muted"
                                style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ item.description | truncate(60) }}
                            </p>
                        </td>
                        <td style="padding: 0.75rem;">
                            {% if item.status == 'Found' %}
                            <span class="badge badge-success">Found</span>
                            {% else %}
                            <span class="badge badge-warning">Lost</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem;">
                            <span class="text-sm">{{ item.lost_found_date.strftime('%b %d, %Y') }}</span>
                        </td>
                        <td style="padding: 0.75rem;">
                            <span class="text-sm">{{ item.location | truncate(30) }}</span>
                        </td>
                        <td style="padding: 0.75rem;">
                            <div class="text-sm font-medium">{{ item.reporter.full_name }}</div>
                            <div class="text-xs text-muted">{{ item.reporter.registration_no }}</div>
                        </td>
                        <td style="padding: 0.75rem;">
                            <span class="text-sm">{{ item.reported_at.strftime('%b %d, %Y') }}</span>
                            <div class="text-xs text-muted">{{ item.reported_at.strftime('%H:%M') }}</div>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            {% if item.is_active %}
                            <span class="badge badge-success">Active</span>
                            {% else %}
                            <span class="badge badge-destructive">Archived</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem;">
                            {% if not item.is_active and item.deleter %}
                            <div class="text-sm">{{ item.deleter.full_name }}</div>
                            <div class="text-xs text-muted">{{ item.deleted_at.strftime('%b %d, %H:%M') if
                                item.deleted_at else 'N/A' }}</div>
                            {% else %}
                            <span class="text-muted text-xs">â€”</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn btn-sm btn-outline"
                                title="View Details">
                                View
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" style="padding: 3rem; text-align: center;">
                            <div style="opacity: 0.3; margin-bottom: 1rem;">
                                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"
                                    viewBox="0 0 24 24" style="margin: 0 auto;">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z">
                                    </path>
                                </svg>
                            </div>
                            <p class="text-muted">No items found in history</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="card mt-6">
        <div class="card-content">
            <div class="grid grid-cols-3" style="gap: 2rem;">
                <div style="text-align: center;">
                    <div class="text-2xl font-bold text-primary">{{ items | selectattr('is_active') | list | length }}
                    </div>
                    <div class="text-sm text-muted mt-1">Active Items</div>
                </div>
                <div style="text-align: center;">
                    <div class="text-2xl font-bold text-destructive">{{ items | rejectattr('is_active') | list | length
                        }}</div>
                    <div class="text-sm text-muted mt-1">Archived Items</div>
                </div>
                <div style="text-align: center;">
                    <div class="text-2xl font-bold">{{ items | length }}</div>
                    <div class="text-sm text-muted mt-1">Total Items</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Responsive table */
    @media (max-width: 1024px) {
        table {
            font-size: 0.875rem;
        }

        th,
        td {
            padding: 0.5rem !important;
        }
    }

    @media (max-width: 768px) {
        .grid.grid-cols-3 {
            grid-template-columns: 1fr !important;
        }

        table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
    }

    /* Table hover effect */
    tbody tr:hover {
        background: hsl(var(--muted) / 0.3);
        transition: var(--transition-fast);
    }
</style>
{% endblock content %}